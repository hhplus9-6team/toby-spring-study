# 1.6 싱글톤 레지스트리와 오브젝트 스코프

기존의 DaoFactory의 userDao()로 반환되는 UserDao 오브젝트와 스프링 애플리케이션 컨텍스트가 반환해주는 UserDao 오브젝트에는 차이가 있다.

> **동일성과 동등성**
>
> - 동일성(identical): 두 개의 오브젝트가 완전히 같음, == 비교
> - 동등성(equality): 동일한 정보를 담고있는 객체 (두 오브젝트는 서로 같지 않음), equals() 비교

```java

DaoFactory factory = new DaoFactory();
UserDao dao1 = factory.userDao();
UserDao dao2 = factory.userDao();

ApplicationContext ct = new AnnotationConfigApplicationContext();
UserDao dao3 = ct.getBean("userDao", UserDao.class);
UserDao dao4 = ct.getBean("userDao", UserDao.class);


System.out.println(dao1 == dao2); // false
System.out.println(dao3 == dao4); // true

```

각각 서로 다른 방식(DaoFactory, ApplicationContext)으로 생성한 오브젝트의 동일성 비교를 하면 위와 같은 결과를 확인할 수 있다.

- **스프링은 여러 번에 걸쳐 빈을 요청하더라도 매번 동일한 오브젝트를 돌려준다.**

---

## 1.6.1 싱글톤 레지스트리로서의 애플리케이션 컨텍스트

> 애플리케이션 컨텍스트: 빈 팩토리를 확장한 IoC 컨테이너. 빈을 등록하고 관리하는 기본적인 빈 팩토리의 기능 뿐만 아니라 스프링이 제공하는 각종 부가 서비스를 추가로 제공

애플리케이션 컨텍스트는 싱글톤을 저장하고 관리하는 **싱글톤 레지스트리**이다.

### 서버 애플리케이션과 싱글톤

스프링은 엔터프라이즈 시스템을 위해 고안된 기술이기 때문에 서버 환경에서 사용될 때 그 가치가 있다.

> “서버 환경”이란 **여러 사용자의 요청을 동시에 처리하며(DB·트랜잭션·보안·운영 같은 공통 문제를 다뤄야 하는) 백엔드 실행 환경**

매번 클라이언트의 요청을 처리하기 위해 로직을 담당하는 오브젝트를 새로 생성할 경우 서버에 큰 부하가 발생할 수있음.

멀티 스레드 환경에서 동작하는 서블릿은 싱글톤 방식으로 동작

> 싱글톤 패턴: 어떤 클래스를 애플리케이션 내에서 제한된 인스턴스 개수(주로 하나)만큼만 존재하도록 강제하는 패턴

### 싱글톤 패턴의 한계

일반적인 Java의 싱글톤 구현

```java

public class UserDao {

  // 생성된 싱글톤 오브젝트를 저장하기 위한 스태틱 필드
  private static UserDao INSTANCE;

  ...

  // 클래스 밖에서 오브젝트를 생성하지 못하도록 생성자를 private
  private UserDao(ConnectionMaker cm) {
    this.connectionMaker = cm;
  }

  public static synchronized UserDao getInstance() {
    if (INSTANCE == null) INSTANCE = new UserDao(...);
    return INSTANCE;
  }
}

```

- private 생성자를 갖고 있기 떄문에 상속할 수 없다.
- 싱글톤은 테스트하기가 힘들다.
  - 싱글톤 객체 생성을 위한 방식이 제한적이기 때문에 목 오브젝트등으로 대체가 힘들다.
- 서버 환경에서 싱글톤이 하나만 만들어지는 것을 보장하지 못한다.
  - 여러 개의 JVM 분산 환경에서 독립적으로 오브젝트가 생성
- 싱글톤의 사용은 전역 상태를 만들 수 있기 떄문에 바람직하지 못하다.
  - 아무 객체나 자유럽게 접근하고 수정할 수 있는 전역 상태를 갖는것은 객체지향 프로그래밍에서 권장되지 않음.

### 싱글톤 레지스트리

스프링은 "싱글톤 레지스트리"라는 직접 싱글톤 형태의 오브젝트를 만들고 관리하는 기능을 제공한다.

- 평범한 자바 클래스를 싱글톤으로 활용할 수 있도록 해줌.
  - private -> public
  - 테스트 환경에서 자유롭게 오브젝트 생성

## 1.6.2 싱글톤과 오브젝트의 상태

싱글톤은 멀티스레드 환경에리면 여러 스레드가 동시에 접근해서 사용할 수 있다.

멀티스레드 환경에서 서비스 형태의 오브젝트로 사용되는 경우에는 상태정보를 내부에 갖고있지 않은 **무상태 방식**으로 만들어져야 한다.

상태가 없는 방식으로 클래스를 만드는 경우 각 요청에 대한 정보, DB나 서버의 리소스로브터 생성한 정보를 다루는 방법 -> 로컬변수, 리턴값등을 이용

```java
@Service
public class OrderPriceService_Bad {

    // ❌ 공유 상태: 모든 요청(스레드)이 이 필드를 같이 씀
    private int lastCalculatedTotal;

    public int calculateTotal(int userId, List<Integer> itemPrices) {
        int sum = 0;
        for (int price : itemPrices) {
            sum += price;
        }

        // 요청별 결과를 필드에 저장해버림 → 다른 요청이 덮어씀
        lastCalculatedTotal = sum;

        return lastCalculatedTotal;
    }

    public int getLastCalculatedTotal() {
        return lastCalculatedTotal;
    }
}


//무상태
@Service
public class OrderPriceService {

    public int calculateTotal(int userId, List<Integer> itemPrices) {
        // ✅ 요청별 값은 로컬 변수로만 유지
        int sum = 0;
        for (int price : itemPrices) {
            sum += price;
        }

        // ✅ 요청별 결과는 리턴값으로 반환
        return sum;
    }
}

```

## 1.6.3 스프링 빈의 스코프

싱글톤 스코프는 컨테이너 내에 한 개의 오브젝트만 만들어져서, 강제로 제거하지 않는 한 스프링 컨테이너가 존재하는 동안 유지됨.

---

### 질문

- 멀티 스레드 환경에서 다음과 같이 싱글톤 객체의 변경 인스턴스 변수가 존재 할 경우 어떤 문제가 발생할 수 있나요?

  ```java
      public class CounterServiceBad {
          private int counter = 0;

          public void increment() {
              counter++;
          }

          public int getCounter() {
              return counter;
          }
      }

  ```

  - 이러한 문제를 방지하기 위해 어떻게 코드를 개선할 수 있나요?
